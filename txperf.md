# tx perf notes

POST to API endpoint /txPerf with query string params

	* d	: duration, overall duration of text (in time.Duration format, e.g. 30s for 30 seconds)
	* n : number of concurrent requests

## v1

concurrent calls to concatTx where none of the keys overal, all tx's commit.

concatTx parallelizes the initial key reads, and then the check loops.

api -> view comms is protobuf / grpc over tcp

run from Simon's laptop (4 partitions, 400k keys totals)

    $ curl -X POST "http://localhost:9988/txPerf?d=30s&n=10"
	
	      n |  Count | Commits | Aborts | Errors |        p25 |        p50 |        p90 |        p99 |
	 ------ | ------ | ------- | ------ | ------ | ---------- | ---------- | ---------- | ---------- |
	      0 |  10990 |   10990 |      0 |      0 | 2.253935ms | 2.554299ms | 3.639982ms | 6.119479ms |
	      1 |  11014 |   11014 |      0 |      0 | 2.250916ms | 2.546791ms | 3.651579ms | 6.073584ms |
	      2 |  10981 |   10981 |      0 |      0 | 2.252267ms | 2.555561ms | 3.656002ms | 6.111583ms |
	      3 |  11003 |   11003 |      0 |      0 | 2.253491ms | 2.550875ms | 3.637321ms | 5.910028ms |
	      4 |  10995 |   10995 |      0 |      0 | 2.255674ms | 2.552709ms |  3.63766ms | 6.123404ms |
	      5 |  10988 |   10988 |      0 |      0 | 2.249159ms | 2.554981ms | 3.637495ms | 5.980126ms |
	      6 |  11020 |   11020 |      0 |      0 | 2.247871ms |  2.54717ms | 3.641092ms | 6.070027ms |
	      7 |  10996 |   10996 |      0 |      0 | 2.248666ms | 2.551715ms | 3.655723ms | 6.184265ms |
	      8 |  10992 |   10992 |      0 |      0 |  2.25068ms | 2.547986ms | 3.672467ms | 6.263325ms |
	      9 |  11010 |   11010 |      0 |      0 | 2.255957ms | 2.551157ms | 3.640059ms | 6.053899ms |
	 ------ | ------ | ------- | ------ | ------ | ---------- | ---------- | ---------- | ---------- |
	 Totals | 109989 |  109989 |      0 |      0 | 2.251869ms | 2.551434ms | 3.647378ms | 6.076723ms |

runs from the (CPU starved) test cluster (4 partitions, 31M keys total)

	$ curl -X POST 'http://10.64.222.170:9988/txPerf?n=3&d=30s'
	      n | Count | Commits | Aborts | Errors |        p25 |        p50 |        p90 |        p99 |
	 ------ | ----- | ------- | ------ | ------ | ---------- | ---------- | ---------- | ---------- |
	      0 |  6995 |    6995 |      0 |      0 | 3.554326ms | 4.082147ms | 5.384104ms | 6.664023ms |
	      1 |  7003 |    7003 |      0 |      0 | 3.561739ms | 4.075915ms | 5.380644ms | 6.557643ms |
	      2 |  7004 |    7004 |      0 |      0 | 3.558788ms | 4.071994ms | 5.406553ms | 6.733389ms |
	 ------ | ----- | ------- | ------ | ------ | ---------- | ---------- | ---------- | ---------- |
	 Totals | 21002 |   21002 |      0 |      0 | 3.558455ms | 4.077201ms | 5.388839ms | 6.661278ms |
 
 
	$ curl -X POST 'http://10.64.222.170:9988/txPerf?n=10&d=30s'
    
	      n | Count | Commits | Aborts | Errors |        p25 |        p50 |        p90 |        p99 |
	 ------ | ----- | ------- | ------ | ------ | ---------- | ---------- | ---------- | ---------- |
	      0 |  5777 |    5777 |      0 |      0 | 4.509207ms | 4.963015ms |  6.52851ms | 8.306778ms |
	      1 |  5791 |    5791 |      0 |      0 | 4.491836ms | 4.965223ms | 6.498762ms | 8.511929ms |
	      2 |  5771 |    5771 |      0 |      0 | 4.513638ms |  4.97315ms | 6.497887ms | 8.488345ms |
	      3 |  5775 |    5775 |      0 |      0 | 4.523596ms | 4.989114ms | 6.497103ms | 8.358485ms |
	      4 |  5777 |    5777 |      0 |      0 | 4.501807ms |  4.97173ms | 6.514702ms | 8.492129ms |
	      5 |  5785 |    5785 |      0 |      0 | 4.491995ms | 4.974467ms | 6.531997ms | 8.405366ms |
	      6 |  5782 |    5782 |      0 |      0 | 4.504235ms | 4.959183ms | 6.511351ms | 8.419784ms |
	      7 |  5777 |    5777 |      0 |      0 | 4.507084ms | 4.985259ms | 6.522974ms | 8.452545ms |
	      8 |  5791 |    5791 |      0 |      0 | 4.509555ms | 4.970714ms | 6.469521ms | 8.403863ms |
	      9 |  5796 |    5796 |      0 |      0 | 4.501561ms | 4.974182ms | 6.454848ms | 8.268034ms |
	 ------ | ----- | ------- | ------ | ------ | ---------- | ---------- | ---------- | ---------- |
	 Totals | 57822 |   57822 |      0 |      0 | 4.504781ms |  4.97239ms | 6.503651ms |    8.406ms |

 
	$ curl -X POST 'http://10.64.222.170:9988/txPerf?n=40&d=30s'
	      n | Count | Commits | Aborts | Errors |         p25 |         p50 |         p90 |         p99 |
	 ------ | ----- | ------- | ------ | ------ | ----------- | ----------- | ----------- | ----------- |
	      0 |  2318 |    2318 |      0 |      0 |  11.17628ms | 12.500508ms |  15.89114ms | 21.428286ms |
	      1 |  2325 |    2325 |      0 |      0 | 11.197525ms | 12.509977ms | 15.894769ms | 20.397429ms |
	      2 |  2325 |    2325 |      0 |      0 | 11.209184ms | 12.477759ms | 15.684045ms | 21.130596ms |
	      3 |  2324 |    2324 |      0 |      0 | 11.256309ms | 12.535973ms | 15.694393ms | 20.706044ms |
	      4 |  2324 |    2324 |      0 |      0 | 11.150897ms | 12.525118ms | 15.725756ms | 20.685507ms |
	      5 |  2334 |    2334 |      0 |      0 | 11.084538ms | 12.428186ms |  15.87435ms | 19.905065ms |
	      6 |  2325 |    2325 |      0 |      0 | 11.163279ms | 12.507059ms |  15.80317ms | 19.851712ms |
	      7 |  2326 |    2326 |      0 |      0 |   11.1649ms | 12.538952ms | 15.778604ms | 20.853635ms |
	      8 |  2321 |    2321 |      0 |      0 | 11.163608ms | 12.509325ms | 15.858683ms | 21.143862ms |
	      9 |  2334 |    2334 |      0 |      0 | 11.148344ms | 12.473134ms | 15.779681ms | 19.993648ms |
	     10 |  2318 |    2318 |      0 |      0 | 11.194535ms | 12.503445ms | 15.855583ms |  20.41732ms |
	     11 |  2330 |    2330 |      0 |      0 | 11.141662ms | 12.515018ms | 15.808422ms |  20.69098ms |
	     12 |  2322 |    2322 |      0 |      0 | 11.199372ms | 12.566138ms | 15.780939ms | 20.417281ms |
	     13 |  2322 |    2322 |      0 |      0 | 11.211598ms | 12.502233ms | 15.698635ms |   20.7874ms |
	     14 |  2319 |    2319 |      0 |      0 | 11.204192ms | 12.528053ms | 15.882128ms | 20.594146ms |
	     15 |  2325 |    2325 |      0 |      0 |  11.17287ms | 12.488243ms | 15.849192ms | 20.577152ms |
	     16 |  2332 |    2332 |      0 |      0 | 11.125706ms | 12.446572ms | 15.753166ms | 19.953319ms |
	     17 |  2324 |    2324 |      0 |      0 | 11.200267ms | 12.512882ms | 15.792548ms | 20.362125ms |
	     18 |  2316 |    2316 |      0 |      0 | 11.238531ms | 12.552068ms | 15.760253ms | 21.460571ms |
	     19 |  2324 |    2324 |      0 |      0 | 11.205079ms | 12.474037ms | 15.775946ms |  20.79408ms |
	     20 |  2324 |    2324 |      0 |      0 | 11.166074ms | 12.530559ms | 15.826788ms | 19.871967ms |
	     21 |  2326 |    2326 |      0 |      0 | 11.178013ms | 12.483364ms |  15.90029ms |   20.5644ms |
	     22 |  2332 |    2332 |      0 |      0 | 11.203371ms | 12.434104ms | 15.714305ms | 20.080427ms |
	     23 |  2345 |    2345 |      0 |      0 | 11.111842ms |  12.41071ms | 15.641144ms | 20.007836ms |
	     24 |  2334 |    2334 |      0 |      0 | 11.092434ms | 12.445298ms | 15.842365ms | 20.003472ms |
	     25 |  2334 |    2334 |      0 |      0 | 11.204715ms | 12.408803ms | 15.836841ms | 19.611814ms |
	     26 |  2326 |    2326 |      0 |      0 | 11.146209ms | 12.429335ms | 15.813771ms | 20.599513ms |
	     27 |  2325 |    2325 |      0 |      0 | 11.186994ms | 12.456092ms | 15.909355ms | 20.909692ms |
	     28 |  2337 |    2337 |      0 |      0 | 11.157282ms | 12.406594ms | 15.836925ms | 20.336623ms |
	     29 |  2326 |    2326 |      0 |      0 | 11.207189ms | 12.462755ms | 15.801597ms |  20.33177ms |
	     30 |  2332 |    2332 |      0 |      0 | 11.114939ms | 12.484546ms | 15.786029ms | 20.409474ms |
	     31 |  2329 |    2329 |      0 |      0 | 11.211367ms |  12.50484ms | 15.688294ms | 20.302741ms |
	     32 |  2333 |    2333 |      0 |      0 |  11.18132ms | 12.452621ms | 15.829877ms | 20.037309ms |
	     33 |  2320 |    2320 |      0 |      0 | 11.192314ms | 12.542309ms | 15.814251ms | 20.470232ms |
	     34 |  2318 |    2318 |      0 |      0 |  11.22729ms | 12.485641ms | 15.900739ms | 20.298362ms |
	     35 |  2325 |    2325 |      0 |      0 | 11.241176ms | 12.480455ms | 15.756833ms | 20.875358ms |
	     36 |  2316 |    2316 |      0 |      0 | 11.292909ms | 12.467519ms | 15.714382ms | 20.786038ms |
	     37 |  2332 |    2332 |      0 |      0 | 11.115004ms | 12.484176ms | 15.875266ms | 20.998886ms |
	     38 |  2325 |    2325 |      0 |      0 |  11.24333ms | 12.517982ms | 15.697135ms | 20.505965ms |
	     39 |  2326 |    2326 |      0 |      0 | 11.138517ms | 12.502676ms | 15.752554ms | 20.110293ms |
	 ------ | ----- | ------- | ------ | ------ | ----------- | ----------- | ----------- | ----------- |
	 Totals | 93053 |   93053 |      0 |      0 | 11.181139ms | 12.486816ms | 15.795613ms | 20.549634ms |

# v1.01

No changes to impl, but captures metrics from the api server for both the grpc client calls and the parts of the concat operation, as well as some metrics from inside the kv view.

	$ curl  "http://10.64.222.170:9988/txPerf?n=10&d=30s" -X POST
	      n | Count | Commits | Aborts | Errors |        p25 |        p50 |        p90 |         p99 |
	 ------ | ----- | ------- | ------ | ------ | ---------- | ---------- | ---------- | ----------- |
	      0 |  4961 |    4961 |      0 |      0 | 4.809655ms | 5.485441ms | 8.378652ms | 12.971814ms |
	      1 |  4974 |    4974 |      0 |      0 | 4.810746ms | 5.474865ms | 8.449235ms | 13.122429ms |
	      2 |  4982 |    4982 |      0 |      0 | 4.801694ms | 5.458786ms | 8.392891ms | 13.381601ms |
	      3 |  4986 |    4986 |      0 |      0 | 4.791393ms | 5.478984ms | 8.259431ms | 13.468093ms |
	      4 |  4970 |    4970 |      0 |      0 | 4.800848ms | 5.495659ms | 8.377296ms | 13.643719ms |
	      5 |  4964 |    4964 |      0 |      0 | 4.787477ms | 5.481011ms | 8.451777ms | 13.171411ms |
	      6 |  4966 |    4966 |      0 |      0 |  4.81275ms | 5.495872ms | 8.412181ms | 13.006833ms |
	      7 |  4952 |    4952 |      0 |      0 | 4.814819ms |  5.49151ms | 8.490529ms | 12.819818ms |
	      8 |  4968 |    4968 |      0 |      0 | 4.818379ms | 5.483009ms | 8.387734ms | 13.576759ms |
	      9 |  4975 |    4975 |      0 |      0 | 4.812989ms | 5.505998ms | 8.341296ms | 13.183901ms |
	 ------ | ----- | ------- | ------ | ------ | ---------- | ---------- | ---------- | ----------- |
	 Totals | 49698 |   49698 |      0 |      0 | 4.805451ms | 5.485339ms | 8.398372ms | 13.170964ms |


	              Name |  Count |       Mean |        Min |        p50 |        p90 |        p99 |       p99.9 |         Max |
	 ----------------- | ------ | ---------- | ---------- | ---------- | ---------- | ---------- | ----------- | ----------- |
	  api.concat.check |  49698 | 1.470354ms | 0.380011ms | 0.908798ms | 3.162446ms | 6.042220ms | 19.391853ms | 19.603766ms |
	 api.concat.decide |  49698 | 1.725908ms | 0.697299ms | 1.612008ms | 2.263410ms | 4.930522ms |  8.522582ms |  8.530365ms |
	  api.concat.fetch |  49698 | 1.006237ms | 0.388744ms | 0.823585ms | 1.695089ms | 2.905550ms |  8.197462ms |  8.320637ms |
	  api.concat.write |  49698 | 1.743577ms | 0.665576ms | 1.625817ms | 2.199311ms | 3.617220ms | 23.207951ms | 23.230551ms |
	      client.check | 111626 | 0.797253ms | 0.264890ms | 0.611562ms | 1.373031ms | 2.952623ms |  9.045181ms |  9.065999ms |
	      client.fetch |  99396 | 0.787867ms | 0.262789ms | 0.580670ms | 1.263623ms | 3.096877ms | 12.607300ms | 12.628862ms |
	 client.sampleKeys |      1 | 1.751207ms | 1.751207ms | 1.751207ms | 1.751207ms | 1.751207ms |  1.751207ms |  1.751207ms |

	Partition Metrics: 0
	                      Name |   Count |       Mean |        Min |        p50 |        p90 |        p99 |      p99.9 |        Max |
	 ------------------------- | ------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- |
	      parition.apply.chunk | 1102147 | 0.020455ms | 0.000000ms | 0.009775ms | 0.041715ms | 0.115673ms | 1.617969ms | 1.635003ms |
	 partition.apply.lock.wait | 1102147 | 0.000929ms | 0.000000ms | 0.000622ms | 0.000709ms | 0.012535ms | 0.072397ms | 0.072832ms |
	     partition.check.check |   31615 | 0.001591ms | 0.000000ms | 0.001211ms | 0.001387ms | 0.006846ms | 0.219848ms | 0.225342ms |
	 partition.check.lock.wait |   31615 | 0.000912ms | 0.000000ms | 0.000675ms | 0.000780ms | 0.006340ms | 0.116106ms | 0.119036ms |

	Partition Metrics: 1
	                      Name |   Count |       Mean |        Min |        p50 |        p90 |        p99 |      p99.9 |        Max |
	 ------------------------- | ------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- |
	      parition.apply.chunk | 1103318 | 0.025015ms | 0.000000ms | 0.010776ms | 0.045788ms | 0.145276ms | 3.677897ms | 3.747955ms |
	 partition.apply.lock.wait | 1103318 | 0.000721ms | 0.000000ms | 0.000624ms | 0.000718ms | 0.001531ms | 0.021347ms | 0.021377ms |
	     partition.check.check |   28118 | 0.002077ms | 0.000437ms | 0.001205ms | 0.001463ms | 0.016053ms | 0.308868ms | 0.314916ms |
	 partition.check.lock.wait |   28118 | 0.001264ms | 0.000000ms | 0.000649ms | 0.000765ms | 0.013145ms | 0.241386ms | 0.244760ms |

	Partition Metrics: 2
	                      Name |   Count |       Mean |        Min |        p50 |        p90 |        p99 |      p99.9 |        Max |
	 ------------------------- | ------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- |
	      parition.apply.chunk | 1105969 | 0.021375ms | 0.000000ms | 0.011423ms | 0.049966ms | 0.129660ms | 0.582883ms | 0.592652ms |
	 partition.apply.lock.wait | 1105969 | 0.000692ms | 0.000000ms | 0.000651ms | 0.000722ms | 0.001409ms | 0.013829ms | 0.013833ms |
	     partition.check.check |   28890 | 0.001564ms | 0.000000ms | 0.001275ms | 0.001594ms | 0.010347ms | 0.129536ms | 0.132689ms |
	 partition.check.lock.wait |   28890 | 0.000757ms | 0.000000ms | 0.000672ms | 0.000779ms | 0.001788ms | 0.016485ms | 0.016581ms |

	Partition Metrics: 3
	                      Name |   Count |       Mean |        Min |        p50 |        p90 |        p99 |      p99.9 |        Max |
	 ------------------------- | ------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- | ---------- |
	      parition.apply.chunk | 1100987 | 0.020549ms | 0.000000ms | 0.010595ms | 0.045163ms | 0.152168ms | 1.204626ms | 1.233291ms |
	 partition.apply.lock.wait | 1100987 | 0.000750ms | 0.000000ms | 0.000600ms | 0.000709ms | 0.007111ms | 0.021857ms | 0.021860ms |
	     partition.check.check |   31488 | 0.001487ms | 0.000000ms | 0.001228ms | 0.001573ms | 0.010956ms | 0.066043ms | 0.066196ms |
	 partition.check.lock.wait |   31488 | 0.000766ms | 0.000000ms | 0.000632ms | 0.000743ms | 0.001228ms | 0.064712ms | 0.066040ms |
